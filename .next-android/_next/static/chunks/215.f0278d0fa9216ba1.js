"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[215],{9215:function(e,t,r){r.r(t),r.d(t,{default:function(){return o}});var a=r(7437),s=r(2265);function n(e){let{onImageSelected:t,disabled:r=!1}=e,[n,l]=(0,s.useState)(null),i=(0,s.useRef)(null);return(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{ref:i,type:"file",accept:"image/*",onChange:e=>{var r;let a=null===(r=e.target.files)||void 0===r?void 0:r[0];if(a&&a.type.startsWith("image/")){if(a.size>5242880){alert("La imagen debe ser menor a 5MB");return}let e=new FileReader;e.onloadend=()=>{l(e.result)},e.readAsDataURL(a),t(a)}},className:"hidden",disabled:r}),n?(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("img",{src:n,alt:"Preview",className:"w-20 h-20 object-cover rounded-lg border-2 border-blue-500"}),(0,a.jsx)("button",{onClick:()=>{l(null),i.current&&(i.current.value="")},className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600",children:"\xd7"})]}):(0,a.jsx)("button",{onClick:()=>{if(!r){var e;null===(e=i.current)||void 0===e||e.click()}},disabled:r,className:"w-10 h-10 bg-blue-100 hover:bg-blue-200 rounded-lg flex items-center justify-center text-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})})]})}var l=r(1837);let i=(0,r(166).default)(()=>r.e(740).then(r.bind(r,6740)),{loadableGenerated:{webpack:()=>[6740]},ssr:!1});function o(e){var t;let{requestId:o,currentUserId:c,onClose:d,requestDescription:u,otherPersonName:h,otherPersonAvatar:m}=e,[x,b]=(0,s.useState)([]),[g,f]=(0,s.useState)(""),[p,j]=(0,s.useState)(!1),[v,w]=(0,s.useState)(null),[y,N]=(0,s.useState)(!1),[k,C]=(0,s.useState)(!1),L=(0,s.useRef)(null);(0,s.useRef)(null),(0,s.useRef)(!1);let D=(0,s.useRef)(null),_=(0,s.useRef)(0),S=(e,t)=>{let r=new Map;for(let t of e)r.set(t.id,t);for(let e of t)r.set(e.id,e);return Array.from(r.values()).sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime())};(0,s.useEffect)(()=>{let e=localStorage.getItem("auth_token")||localStorage.getItem("token");(0,l.S)("/api/v1/requests/".concat(o,"/messages"),{headers:e?{Authorization:"Bearer ".concat(e)}:{}}).then(e=>e.json()).then(e=>b(t=>{var r;return S(t,null!==(r=e.data)&&void 0!==r?r:[])})).catch(()=>{})},[o]),(0,s.useEffect)(()=>{let e=null,t=!1;return Promise.all([r.e(11),r.e(426)]).then(r.bind(r,2426)).then(r=>{let{getEcho:a}=r;if(t||(console.log("[Chat] Echo instance:",(e=a())?"OK":"NULL"),!e))return;let s="chat.".concat(o);console.log("[Chat] Subscribing to private channel:",s);let n=e.private(s);n.subscribed(()=>console.log("[Chat] ✅ Subscribed to",s)).error(e=>console.error("[Chat] ❌ Channel error:",JSON.stringify(e))),n.listen(".message.new",e=>{var t,r;console.log("[Chat] \uD83D\uDCE8 Message received:",e);let a=null!==(r=null!==(t=null==e?void 0:e.message)&&void 0!==t?t:e)&&void 0!==r?r:null;a&&"number"==typeof a.id&&b(e=>S(e,[a]))}),n.listen(".typing",e=>{e.user_id!==c&&(C(!0),setTimeout(()=>C(!1),3e3))})}),()=>{t=!0,e&&e.leave("chat.".concat(o))}},[o,c]),(0,s.useEffect)(()=>{var e;null===(e=L.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[x]);let M=()=>{N(!0),D.current&&clearTimeout(D.current),D.current=setTimeout(()=>{N(!1)},1e3);let e=Date.now();e-_.current<3e3||(_.current=e,Promise.all([r.e(11),r.e(426)]).then(r.bind(r,2426)).then(e=>{let{getEcho:t}=e,r=t();if(r)try{r.private("chat.".concat(o)).whisper("typing",{user_id:c})}catch(e){}}))},E=async()=>{if((g.trim()||v)&&!p){j(!0),N(!1);try{let e=localStorage.getItem("auth_token")||localStorage.getItem("token"),t=new FormData;v&&t.append("image",v),g.trim()&&t.append("body",g.trim());let r=await (0,l.S)("/api/v1/requests/".concat(o,"/messages"),{method:"POST",headers:{...e?{Authorization:"Bearer ".concat(e)}:{}},body:t}),a=await r.json();if(r.ok){let e={id:a.data.id,sender_id:a.data.sender_id,sender_name:a.data.sender_name,sender_avatar:null,body:a.data.body,type:a.data.type,created_at:a.data.created_at};b(t=>S(t,[e])),f(""),w(null)}else console.error("Error enviando mensaje:",a)}catch(e){console.error("Error de red:",e)}j(!1)}},z=async()=>{if(!navigator.geolocation){alert("Tu navegador no soporta geolocalizaci\xf3n");return}navigator.geolocation.getCurrentPosition(async e=>{let{latitude:t,longitude:r}=e.coords,a="https://www.google.com/maps?q=".concat(t,",").concat(r);f("\uD83D\uDCCD Mi ubicaci\xf3n: ".concat(a))},e=>{alert("Error obteniendo ubicaci\xf3n: "+e.message)})},R=e=>new Date(e).toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"});return(0,a.jsxs)("div",{className:"fixed inset-0 z-[300] flex flex-col",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:d}),(0,a.jsxs)("div",{className:"relative mt-auto w-full max-w-md mx-auto bg-white rounded-t-3xl shadow-2xl flex flex-col overflow-hidden",style:{height:"75vh",maxHeight:"600px"},children:[(0,a.jsxs)("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 p-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[m?(0,a.jsx)("img",{src:m,alt:h,className:"w-10 h-10 rounded-full object-cover ring-2 ring-white/30"}):(0,a.jsx)("div",{className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center",children:(0,a.jsx)("span",{className:"text-white font-black text-lg",children:null!==(t=null==h?void 0:h.charAt(0))&&void 0!==t?t:"\uD83D\uDCAC"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-black text-white text-sm leading-tight",children:null!=h?h:"Chat"}),u&&(0,a.jsx)("p",{className:"text-white/70 text-xs truncate max-w-[180px]",children:u})]})]}),(0,a.jsx)("button",{onClick:d,className:"w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50 to-white",children:[0===x.length&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-3",children:(0,a.jsx)("svg",{className:"w-8 h-8 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),(0,a.jsx)("p",{className:"text-gray-400 text-sm font-medium",children:"Sin mensajes a\xfan"}),(0,a.jsx)("p",{className:"text-gray-300 text-xs mt-1",children:"Comienza la conversaci\xf3n"})]}),k&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-gray-500 text-sm italic",children:[(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),(0,a.jsx)("span",{children:"Escribiendo..."})]}),x.map(e=>{let t=e.sender_id===c;return"system"===e.type?(0,a.jsx)("div",{className:"text-center",children:(0,a.jsx)("span",{className:"inline-block text-xs text-gray-500 bg-gray-100 px-4 py-1.5 rounded-full font-medium",children:e.body})},e.id):(0,a.jsxs)("div",{className:"flex items-end gap-2 ".concat(t?"justify-end":"justify-start"),children:[!t&&(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center text-white text-xs font-bold shrink-0",children:e.sender_name.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{className:"max-w-[75%] ".concat(t?"order-2":""),children:[!t&&(0,a.jsx)("p",{className:"text-xs font-semibold text-gray-600 mb-1 px-1",children:e.sender_name}),(0,a.jsxs)("div",{className:"px-4 py-2.5 rounded-2xl shadow-sm ".concat(t?"bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-br-sm":"bg-white text-gray-800 border border-gray-200 rounded-bl-sm"),children:["image"===e.type?(0,a.jsx)("div",{children:(()=>{try{let t=JSON.parse(e.body);return(0,a.jsxs)("div",{children:[(0,a.jsx)("img",{src:t.image_url,alt:t.caption||"Imagen",className:"max-w-full rounded-lg mb-2"}),t.caption&&(0,a.jsx)("p",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:t.caption})]})}catch(t){return(0,a.jsx)("p",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:e.body})}})()}):"location"===e.type?(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm mb-2",children:"\uD83D\uDCCD Ubicaci\xf3n compartida"}),(0,a.jsx)("a",{href:e.body,target:"_blank",rel:"noopener noreferrer",className:"text-xs underline",children:"Ver en mapa"})]}):(0,a.jsx)("p",{className:"text-sm leading-relaxed whitespace-pre-wrap break-words",children:e.body}),(0,a.jsx)("p",{className:"text-[10px] mt-1.5 ".concat(t?"text-white/70":"text-gray-400"),children:R(e.created_at)})]})]}),t&&(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold shrink-0",children:"T\xfa"})]},e.id)}),(0,a.jsx)("div",{ref:L})]}),(0,a.jsxs)("div",{className:"p-4 bg-white border-t border-gray-200",children:[v&&(0,a.jsxs)("div",{className:"mb-3 flex items-center gap-2",children:[(0,a.jsx)("img",{src:URL.createObjectURL(v),alt:"Preview",className:"w-16 h-16 object-cover rounded-lg border-2 border-blue-500"}),(0,a.jsx)("button",{onClick:()=>w(null),className:"text-red-500 hover:text-red-700",children:(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(n,{onImageSelected:w,disabled:p}),(0,a.jsx)("button",{onClick:z,disabled:p,className:"w-10 h-10 bg-green-100 hover:bg-green-200 rounded-lg flex items-center justify-center text-green-600 transition disabled:opacity-50",title:"Compartir ubicaci\xf3n",children:(0,a.jsxs)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]})}),(0,a.jsx)("input",{value:g,onChange:e=>{f(e.target.value),M()},onKeyDown:e=>"Enter"===e.key&&!e.shiftKey&&E(),placeholder:"Escribe un mensaje...",className:"flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition placeholder:text-gray-400 border border-transparent focus:border-blue-200",maxLength:1e3}),(0,a.jsx)(i,{onTranscript:e=>f(t=>t?t+" "+e:e)}),(0,a.jsx)("button",{onClick:E,disabled:p||!g.trim()&&!v,className:"w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white hover:from-blue-600 hover:to-blue-700 transition shadow-lg hover:shadow-xl disabled:opacity-40 disabled:cursor-not-allowed shrink-0",children:p?(0,a.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):(0,a.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]})]})]})}},1837:function(e,t,r){r.d(t,{S:function(){return s}});let a="https://jobshour.dondemorales.cl".replace(/\/api$/,"");async function s(e,t){return fetch(a?"".concat(a).concat(e):e,t)}}}]);